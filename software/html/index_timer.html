<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Main Irrigation Controller</title>
</head>


<body>
    <div>
        <H2>MAIN IRRIGATION CONTROLLER</H2>
        <p id="connectstatus">WebSocket is NOT connected!</p>
    </div>
    <div id="buttons">
        <div id="pumpbuttons">
            <button id="pumpmotoron">
                PUMP MOTOR ON
            </button>
            <button id="pumpmotoroff">
                PUMP MOTOR OFF
            </button>
        </div>
        <div id="zone1buttons">
            <button id="zone1on">
                ZONE 1 ON
            </button>
            <button id="zone1off">
                ZONE 1 OFF
            </button>

        </div>
        <div id="zone2buttons">
            <button id="zone2on">
                ZONE 2 ON
            </button>
            <button id="zone2off">
                ZONE 2 OFF
            </button>
        </div>
    </div>

    <div id="status">
        <h3>Irrigation Server Status Messages</h3>
        <p id="pumpstatus">No report from pump.</p>
        <p id="zone1status">No report from zone 1.</p>
        <p id="zone2status">No report from zone 2.</p>
    </div>

    <div id="timer">
        <h3>Timer Setting</h3>
        <p>
            <label for="startDate">Start Irrigation Date:</label>
            <input id="startDate" type="date">
        </p>
        <p>
            <label for="starttime">Stop Irrigation Time:</label>
            <input id="startTime" type="time" value="06:00:00">
        </p>
        <p>
            <label for="stopTime">Stop Irrigation Time:</label>
            <input id="stopTime" type="time" value="07:00:00">
        </p>
    </div>
    <div id="scheduler">
        <button id="schedulebutton">
            Schedule Irrigation
        </button>
    </div>
    <div id="irrigationschedule">
        <p>Current Irrigation Schedule</p>
        <p>Date</p>
        <p>Start Time</p>
        <p>Stop Time</p>
    </div>
    <script>
        //  Open a WebSocket to the server.
        let ws = new WebSocket('ws://192.168.1.8:8089');
        // Get buttons.
        let pumpbuttonon = document.getElementById('pumpmotoron');
        let pumpbuttonoff = document.getElementById('pumpmotoroff');
        let zone1buttonon = document.getElementById('zone1on');
        let zone1buttonoff = document.getElementById('zone1off');
        let zone2buttonon = document.getElementById('zone2on');
        let zone2buttonoff = document.getElementById('zone2off');
        // Get status indicator texts.
        let connectstatus = document.getElementById('connectstatus');
        let pumpstatus = document.getElementById('pumpstatus');
        let zone1status = document.getElementById('zone1status');
        let zone2status = document.getElementById('zone2status');

        ws.onopen = () => {
            console.log('Web browser opened a WebSocket.');
            //  Update the connection status in the browser.
            connectstatus.textContent = "WebSocket Connected";
        }

        ws.onclose = () => {
            console.log('Web browser WebSocket just closed.');
            //  Update the connection status in the browser.
            connectstatus.textContent = "WebSocket is disconnected";
        }

        //  Get messages from irrigation server and update status.
        ws.onmessage = (message) => {
            console.log(message.data);
            let statusmessage = JSON.parse(message.data);
//  Check the message type and handle as required.
            switch (statusmessage[0]) {
                case 'pumpmotor':
                    pumpstatus.textContent = 'Pump status: ' + statusmessage[1];
                    break;
                case 'zone1':
                    zone1status.textContent = 'Zone 1 status: ' + statusmessage[1];
                    break;
                case 'zone2':
                    zone2status.textContent = 'Zone2 status: ' + statusmessage[1];
                    break;
            }
        }

        //  Manual control button event handler.       
        buttonevent = (device, state, buttonon, buttonoff) => {
            if (ws.readyState === ws.OPEN) {
                console.log(`Sending ${state} to device ${device}`);
                ws.send(`{"messageType":"pumpControl", "control":{${device}":${state}}}`);
                if (state === 1) {
                    buttonon.style.color = "green";
                    buttonoff.style.color = "black";
                } else if (state === 0) {
                    buttonon.style.color = "black";
                    buttonoff.style.color = "green";
                }
            } else {
                console.log('Websocket is not open.  Message aborted.');
            }
        }

        pumpbuttonon.addEventListener('click', () => {
            buttonevent('pumpmotor', 1, pumpbuttonon, pumpbuttonoff);
        });
        pumpbuttonoff.addEventListener('click', () => {
            buttonevent('pumpmotor', 0, pumpbuttonon, pumpbuttonoff);
        });
        zone1buttonon.addEventListener('click', () => {
            buttonevent('zone1', 1, zone1buttonon, zone1buttonoff);
        });
        zone1buttonoff.addEventListener('click', () => {
            buttonevent('zone1', 0, zone1buttonon, zone1buttonoff);
        });
        zone2buttonon.addEventListener('click', () => {
            buttonevent('zone2', 1, zone2buttonon, zone2buttonoff);
        });
        zone2buttonoff.addEventListener('click', () => {
            buttonevent('zone2', 0, zone2buttonon, zone2buttonoff);
        });
        //  Initialize the Date input form.
        document.getElementById('startDate').valueAsDate = new Date();



        //  Scheduler button event handler.       
        scheduleevent = () => {
            if (ws.readyState === ws.OPEN) {
                //  Construct Object to send to server with scheduling data.
                let startDate = document.getElementById('startDate').value;
                let startTime = document.getElementById('startTime').value;
                let stopTime = document.getElementById('stopTime').value;
                let scheduleObject = `{"messageType":"schedule", "startDate": "${startDate}", "startTime":"${startTime}", "stopTime":"${stopTime}"}`;
              //  let scheduleMap = {"test":"this"};
                console.log(`Sending schedule to server.`);
                ws.send(scheduleObject);
            } else {
                console.log('Websocket is not open.  Message aborted.');
            }
        }

        schedulebutton.addEventListener('click', () => {
            scheduleevent();
        });

    </script>
</body>

</html>
